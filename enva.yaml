# Lab CLI Configuration - K3s with ArgoCD

# Environments configuration (required infrastructure)
environments:
  dev:
    id-base: 4000
    network: "10.11.4.0/24"
    dns_server: "10.11.4.17"
    domain: "dev.net"
    branch: "main"
    lxc:
      host: "root@10.11.4.4" # do not use ssh or pct, use configured local kubectl
      storage: "sdb"
      bridge: "vmbr0"
      template_dir: "/var/lib/vz/template/cache"
      gateway_octet: 253  # Last octet of gateway IP
  test:
    id-base: 3000
    network: "10.11.3.0/24"
    dns_server: "10.11.3.17"
    domain: "test.net"
    branch: "test"
    lxc:
      host: "root@10.11.3.4" # do not use ssh or pct, use configured local kubectl
      storage: "sdb"
      bridge: "vmbr0"
      template_dir: "/var/lib/vz/template/cache"
      gateway_octet: 253  # Last octet of gateway IP
  prod:
    id-base: 2000
    network: "10.11.2.0/24"
    dns_server: "10.11.2.17"
    domain: "prod.net"
    branch: "dev"
    lxc:
      host: "root@10.11.2.4" # do not use ssh or pct, use configured local kubectl
      storage: "sdb"
      bridge: "vmbr0"
      template_dir: "/var/lib/vz/template/cache"
      gateway_octet: 253  # Last octet of gateway IP

# Template generation configuration (required for building containers)
templates:
  - name: ubuntu-tmpl
    id: 10
    ip: 10  # Last octet only
    hostname: "ubuntu-tmpl"
    template: base
    resources:
      memory: 2048
      swap: 2048
      cores: 4
      rootfs_size: 20
    actions:
      - locale configuration
      - apt sources fix
      - system upgrade
      - openssh-server installation
      - SSH service enablement
      - base tools installation
      - template cleanup
      - template archive creation

ct:
  - name: haproxy
    id: 17
    ip: 17  # Last octet only
    hostname: "haproxy"
    autostart: true
    template: ubuntu-tmpl
    resources:
      memory: 2048
      swap: 2048
      cores: 2
      rootfs_size: 10
    params:
      http_port: 80
      https_port: 443
      stats_port: 8404
    actions:
      - cloud-init wait
      - haproxy installation
      - name: haproxy configuration
        properties:
          http_port: 80
          https_port: 443
          stats_port: 8404
      - haproxy systemd override
      - haproxy service enablement
  - name: k3s-control
    id: 11
    ip: 11  # Last octet only
    hostname: "k3s-control"
    autostart: true
    template: ubuntu-tmpl
    privileged: true
    nested: true
    resources:
      memory: 4096
      swap: 4096
      cores: 8
      rootfs_size: 40
    params:
      port: 6443
    actions:
      - cloud-init wait
      - lxc sysctl access configuration
      - k3s installation
      - install k3s node watcher  # NOT REQUESTED (supporting action)
  - name: k3s-worker-1
    id: 12
    ip: 12  # Last octet only
    hostname: "k3s-worker-1"
    autostart: true
    template: ubuntu-tmpl
    privileged: true
    nested: true
    resources:
      memory: 16384
      swap: 16384
      cores: 8
      rootfs_size: 40
    actions:
      - cloud-init wait
      - lxc sysctl access configuration
      - k3s installation
      - glusterfs server installation
  - name: k3s-worker-2
    id: 13
    ip: 13  # Last octet only
    hostname: "k3s-worker-2"
    autostart: true
    template: ubuntu-tmpl
    privileged: true
    nested: true
    resources:
      memory: 16384
      swap: 16384
      cores: 8
      rootfs_size: 40
    actions:
      - cloud-init wait
      - lxc sysctl access configuration
      - k3s installation
      - glusterfs server installation
  - name: k3s-worker-3
    id: 14
    ip: 14  # Last octet only
    hostname: "k3s-worker-3"
    autostart: true
    template: ubuntu-tmpl
    privileged: true
    nested: true
    resources:
      memory: 16384
      swap: 16384
      cores: 8
      rootfs_size: 40
    actions:
      - cloud-init wait
      - lxc sysctl access configuration
      - k3s installation
      - glusterfs server installation

kubernetes:
  control:
    - id: 11
  workers:
    - id: 12
    - id: 13
    - id: 14
  actions:
    - install metallb
    - update haproxy configuration
    - install dnsdist
    - install argocd
    - create github runner secret
    - name: install argocd apps
      properties:
        repo_url: "https://github.com/swipentap/envaapps"
        path: "applications"
        target_revision: "main"

# NOT REQUESTED: Script timeouts (in seconds)
timeouts:
  ubuntu_template: 1200

# NOT REQUESTED: User configuration
users:
  - name: "jaal"
    password: "jaal123"
    sudo_group: "sudo"

# Network services (argocd ports are needed for the requested services)
services:
  argocd:
    ports:
      - name: argocd
        port: 30080
        type: http

dns:
  servers:
    - "8.8.8.8"
    - "8.8.4.4"

template_config:
  base:
    - "ubuntu-25.04-standard_25.04-1.1_amd64.tar.zst"
  patterns:
    ubuntu: "ubuntu-25.04-template_{date}_amd64.tar.zst"
  preserve:
    - "ubuntu-25.04-template_*.tar.zst"

waits:
  container_startup: 20
  container_ready_max_attempts: 30
  container_ready_sleep: 3
  network_config: 5
  service_start: 10
  glusterfs_setup: 30

# GlusterFS distributed storage configuration
glusterfs:
  volume_name: "shared-storage"
  brick_path: "/gluster/brick"
  mount_point: "/mnt/gluster"
  replica_count: 3  # Replicate across 3 GlusterFS nodes
  cluster_nodes:
    - id: 12
    - id: 13
    - id: 14
