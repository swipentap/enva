---
- name: Install k3s on control node
  hosts: k3s_control
  become: yes
  tasks:
    - name: Install k3s server
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--write-kubeconfig-mode 644" sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for k3s service to be active
      systemd:
        name: k3s
        state: started
      register: k3s_service_status
      until: k3s_service_status.status.ActiveState == "active"
      retries: 30
      delay: 5

    - name: Get k3s token
      shell: cat /var/lib/rancher/k3s/server/node-token
      register: k3s_token
      changed_when: false

    - name: Set k3s token fact (cacheable)
      set_fact:
        k3s_token: "{{ k3s_token.stdout }}"
        cacheable: yes

    - name: Wait for k3s API to be ready
      uri:
        url: https://localhost:6443
        method: GET
        validate_certs: no
        status_code: [401, 403]
      register: k3s_api_check
      until: k3s_api_check.status in [401, 403]
      retries: 30
      delay: 5
      ignore_errors: yes

    - name: Update kubeconfig with control node IP
      replace:
        path: /etc/rancher/k3s/k3s.yaml
        regexp: 'server: https://127\.0\.0\.1:6443'
        replace: 'server: https://10.11.4.11:6443'
      when: k3s_api_check.status in [401, 403]

    - name: Copy kubeconfig to root
      copy:
        src: /etc/rancher/k3s/k3s.yaml
        dest: /root/.kube/config
        owner: root
        group: root
        mode: '0600'
        remote_src: yes

- name: Install k3s agents on worker nodes
  hosts: k3s_workers
  become: yes
  vars:
    k3s_token: "{{ hostvars[groups['k3s_control'][0]]['k3s_token'] }}"
    k3s_control_ip: "10.11.4.11"
  tasks:
    - name: Uninstall existing k3s agent if present
      shell: /usr/local/bin/k3s-agent-uninstall.sh || true
      failed_when: false
      changed_when: false

    - name: Install k3s agent
      shell: |
        curl -sfL https://get.k3s.io | K3S_URL=https://{{ k3s_control_ip }}:6443 K3S_TOKEN={{ k3s_token }} sh -
      args:
        creates: /usr/local/bin/k3s-agent

    - name: Wait for k3s-agent service to be active
      systemd:
        name: k3s-agent
        state: started
      register: k3s_agent_status
      until: k3s_agent_status.status.ActiveState == "active"
      retries: 30
      delay: 5

- name: Verify k3s cluster
  hosts: k3s_control
  become: yes
  tasks:
    - name: Wait for all nodes to be ready
      shell: kubectl get nodes --no-headers | grep -c Ready
      register: ready_nodes
      until: ready_nodes.stdout | int >= 4
      retries: 30
      delay: 10

    - name: Show cluster nodes
      shell: kubectl get nodes -o wide
      register: cluster_nodes
      changed_when: false

    - name: Display cluster status
      debug:
        msg: "{{ cluster_nodes.stdout_lines }}"

    - name: Taint control plane node
      shell: kubectl taint nodes k3s-control node-role.kubernetes.io/control-plane:NoSchedule --overwrite
      failed_when: false
      changed_when: false
